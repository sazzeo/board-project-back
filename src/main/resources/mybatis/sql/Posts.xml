<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jy.board.posts.dao.PostsRepository">

    <!-- 첨부파일 정보조회 -->
    <!--    <select id="selectPosts" resultType="PostsDto">-->
    <!--        SELECT *-->
    <!--        FROM Posts-->
    <!--    </select>-->

    <select id="selectPost" resultType="PostsDto">
        SELECT *
        FROM POSTS
        WHERE POSTS_SEQ = #{postsSeq}
    </select>

    <insert id="insertPost" parameterType="PostsDto">
        INSERT INTO POSTS(TITLE, CONTENT , MEMBER)
        VALUES(#{title} , #{content} , #{member})
        <selectKey keyProperty="postsSeq" resultType="long" order="AFTER">
            select currval('POSTS_SEQ')
        </selectKey>
    </insert>

    <insert id="insertTag" parameterType="TagsDto">
        INSERT INTO TAGS(POSTS_SEQ, TAG_NAME)
        VALUES (#{postsSeq}, #{tagName})
    </insert>

    <update id="updatePost" parameterType="PostsDto">
        UPDATE POSTS
        SET TITLE   = #{title}
          , CONTENT = #{content}
          , MEMBER  = #{MEMBER}
        WHERE POSTS_SEQ = #{postsSeq}
    </update>

    <update id="updatePostsViews" parameterType="long">
        UPDATE POSTS
        SET VIEWS = VIEWS + 1
        WHERE POSTS_SEQ = #{postsSeq}
    </update>

    <select id="selectTagsBySeq" parameterType="Long" resultType="TagsDto">
        SELECT TAG_NAME
        FROM TAGS
        where POSTS_SEQ = #{postsSeq}
        order by TAG_SEQ;
    </select>

    <select id="selectTagsBySeqList" parameterType="list" resultType="TagsDto">
        SELECT POSTS_SEQ ,TAG_NAME
        FROM TAGS
        where POSTS_SEQ in
        <foreach collection="seqList" item="seq" index="index" separator="," open="(" close=")">
            #{seq}
        </foreach>
        order by TAG_SEQ;
    </select>

    <resultMap type="PostsDto" id="postsAndTags">
        <id property="postsSeq" column="POSTS_SEQ"/>
        <result property="title" column="TITLE"/>
        <result property="content" column="CONTENT"/>
        <result property="member" column="MEMBER"/>
        <result property="regDate" column="REG_DATE"/>
        <result property="views" column="VIEWS"/>
        <collection property="tagList" ofType="TagsDto">
            <id property="tagSeq" column="TAG_SEQ"/>
            <result property="tagName" column="TAG_NAME"/>
        </collection>
    </resultMap>


    <select id="selectPosts" resultMap="postsAndTags" resultType="PostsDto">
        SELECT P.POSTS_SEQ,
               P.TITLE,
               P.CONTENT,
               P.MEMBER,
               P.REG_DATE,
               P.VIEWS,
               T.TAG_NAME
        FROM POSTS p
                 LEFT JOIN TAGS t
                           USING (posts_seq)
        ORDER BY P.POSTS_SEQ DESC, T.TAG_SEQ ASC;
    </select>


</mapper>